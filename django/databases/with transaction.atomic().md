## **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï**

**`with transaction.atomic():`**¬†‚Äî —ç—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –≤ Django, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç¬†**–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π**¬†—Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –û–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ª–∏–±–æ¬†**–≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è —É—Å–ø–µ—à–Ω–æ**, –ª–∏–±–æ¬†**–Ω–∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞**¬†(–≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è).
## **–ü–†–û–ë–õ–ï–ú–ê, –ö–û–¢–û–†–£–Æ –†–ï–®–ê–ï–¢ transaction.atomic()**

### **‚ùå –ë–ï–ó –ê–¢–û–ú–ê–†–ù–û–°–¢–ò ‚Äî –ß–ê–°–¢–ò–ß–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï:**
```python
def transfer_money(sender_id, receiver_id, amount):
    """–ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ - –û–ü–ê–°–ù–´–ô –ö–û–î!"""
    
    # 1. –°–Ω–∏–º–∞–µ–º –¥–µ–Ω—å–≥–∏ —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    sender = Account.objects.get(id=sender_id)
    sender.balance -= amount
    sender.save()  # ‚úÖ –î–µ–Ω—å–≥–∏ —Å–Ω—è—Ç—ã!
    
    # 2. –ß—Ç–æ –µ—Å–ª–∏ –∑–¥–µ—Å—å —Å–ª—É—á–∏—Ç—Å—è –æ—à–∏–±–∫–∞?
    # –ù–∞–ø—Ä–∏–º–µ—Ä: —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª, —Å–µ—Ç—å –ø—Ä–æ–ø–∞–ª–∞, –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
    raise Exception("–í–Ω–µ–∑–∞–ø–Ω–∞—è –æ—à–∏–±–∫–∞!")
    
    # 3. –ó–∞—á–∏—Å–ª—è–µ–º –¥–µ–Ω—å–≥–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—é
    receiver = Account.objects.get(id=receiver_id)
    receiver.balance += amount
    receiver.save()  # ‚ùå –ù–ï –í–´–ü–û–õ–ù–ò–¢–°–Ø!
    
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–µ–Ω—å–≥–∏ —Å–Ω—è—Ç—ã, –Ω–æ –Ω–µ –∑–∞—á–∏—Å–ª–µ–Ω—ã!
# –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö!
```
### **‚úÖ –° –ê–¢–û–ú–ê–†–ù–û–°–¢–¨–Æ ‚Äî –í–°–ï –ò–õ–ò –ù–ò–ß–ï–ì–û:**
```python
from django.db import transaction

def transfer_money(safe_sender_id, safe_receiver_id, safe_amount):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥"""
    
    with transaction.atomic():  # üëà –ù–∞—á–∞–ª–æ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –±–ª–æ–∫–∞
        # 1. –°–Ω–∏–º–∞–µ–º –¥–µ–Ω—å–≥–∏
        sender = Account.objects.get(id=safe_sender_id)
        sender.balance -= safe_amount
        sender.save()
        
        # 2. –î–∞–∂–µ –µ—Å–ª–∏ –∑–¥–µ—Å—å –æ—à–∏–±–∫–∞ - –≤—Å—ë –æ—Ç–∫–∞—Ç–∏—Ç—Å—è!
        raise Exception("–í–Ω–µ–∑–∞–ø–Ω–∞—è –æ—à–∏–±–∫–∞!")
        
        # 3. –ó–∞—á–∏—Å–ª—è–µ–º –¥–µ–Ω—å–≥–∏
        receiver = Account.objects.get(id=safe_receiver_id)
        receiver.balance += safe_amount
        receiver.save()
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∏ –æ—à–∏–±–∫–µ –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è!
    # –î–µ–Ω—å–≥–∏ –Ω–∏ —Å –∫–æ–≥–æ –Ω–µ —Å–Ω—è—Ç—ã –∏ –Ω–∏–∫–æ–º—É –Ω–µ –∑–∞—á–∏—Å–ª–µ–Ω—ã
```
## **–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ transaction.atomic()**

### **–ù–∞ —É—Ä–æ–≤–Ω–µ SQL:**
```python
with transaction.atomic():
    # Django –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    doctor.save()
    clinic.save()
```

```sql
-- SQL, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
BEGIN;  -- –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

UPDATE doctor SET ... WHERE id = 1;
UPDATE clinic SET ... WHERE id = 1;

-- –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ:
COMMIT;  -- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è

-- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞:
ROLLBACK;  -- –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è
```
## **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï**

### **–ü—Ä–∏–º–µ—Ä 1: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–∞—á–∞ —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º**
```python
from django.db import transaction

def create_doctor_with_schedule(doctor_data, schedule_data):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–∞—á–∞ –∏ –µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ
    """
    try:
        with transaction.atomic():
            # 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–∞—á–∞
            doctor = Doctor.objects.create(
                last_name=doctor_data['last_name'],
                first_name=doctor_data['first_name'],
                duration=doctor_data['duration'],
                clinic_id=doctor_data['clinic_id']
            )
            
            # 2. –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—Ä–∞—á–∞
            schedule = Schedule.objects.create(
                doctor=doctor,
                date=schedule_data['date'],
                start_time=schedule_data['start_time'],
                end_time=schedule_data['end_time']
            )
            
            # 3. –°–æ–∑–¥–∞–µ–º —Ç–∞–ª–æ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            talons = create_talons_from_schedule(schedule)
            
            # –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ–º–º–∏—Ç–∏—Ç—Å—è
            return doctor
            
    except Exception as e:
        # –ü—Ä–∏ –õ–Æ–ë–û–ô –æ—à–∏–±–∫–µ –≤–Ω—É—Ç—Ä–∏ with - –≤—Å–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–∞—á–∞: {e}")
        raise
```
### **–ü—Ä–∏–º–µ—Ä 2: –ü–µ—Ä–µ–≤–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∫ –¥—Ä—É–≥–æ–º—É –≤—Ä–∞—á—É**
```python
@transaction.atomic
def transfer_patient(patient_id, from_doctor_id, to_doctor_id):
    """
    –ü–µ—Ä–µ–≤–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –º–µ–∂–¥—É –≤—Ä–∞—á–∞–º–∏
    """
    # 1. –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–ø–∏—Å–∏
    Appointment.objects.filter(
        patient_id=patient_id,
        doctor_id=from_doctor_id,
        status='scheduled'
    ).update(status='cancelled')
    
    # 2. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤—Ä–∞—á–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
    patient = Patient.objects.select_for_update().get(id=patient_id)
    patient.doctor_id = to_doctor_id
    patient.save()
    
    # 3. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
    Appointment.objects.create(
        patient_id=patient_id,
        doctor_id=to_doctor_id,
        date=timezone.now().date() + timedelta(days=7)
    )
    
    # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    send_notification(patient_id, 'transfer_completed')
    
    # –í—Å–µ 4 –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è, –ª–∏–±–æ –æ—Ç–∫–∞—Ç—è—Ç—Å—è
```
### **–ü—Ä–∏–º–µ—Ä 3: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–ª–æ–Ω–∞**
```python
def book_talon(patient_id, talon_id):
    """
    –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–ª–æ–Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–º
    """
    with transaction.atomic():
        # –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–∞–ª–æ–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
        talon = Talon.objects.select_for_update().get(id=talon_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–ª–æ–Ω –µ—â–µ —Å–≤–æ–±–æ–¥–µ–Ω
        if talon.status != 'available':
            raise ValidationError("–¢–∞–ª–æ–Ω —É–∂–µ –∑–∞–Ω—è—Ç")
        
        # –ë—Ä–æ–Ω–∏—Ä—É–µ–º —Ç–∞–ª–æ–Ω
        talon.status = 'booked'
        talon.patient_id = patient_id
        talon.booked_at = timezone.now()
        talon.save()
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
        AppointmentHistory.objects.create(
            talon=talon,
            patient_id=patient_id,
            action='booked'
        )
        
        return talon
```
## **–ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ transaction.atomic()**

### **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–≥–¥–∞:**

1. **–ù–µ—Å–∫–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**¬†—Å –ë–î –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
2. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**¬†(–ø–ª–∞—Ç–µ–∂–∏, –ø–µ—Ä–µ–≤–æ–¥—ã)
3. **–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**¬†(—Ç–∞–ª–æ–Ω—ã, –±–∏–ª–µ—Ç—ã, –Ω–æ–º–µ—Ä–∞)
4. **–°–ª–æ–∂–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã**¬†—Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏
5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π**¬†–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    

### **–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–æ–≥–¥–∞:**

1. **–û–¥–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è**¬†(–æ–¥–∏–Ω save() –∏–ª–∏ create())
2. **–¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**¬†(SELECT –∑–∞–ø—Ä–æ—Å—ã)
3. **–û–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**¬†(–æ—Ç–ø—Ä–∞–≤–∫–∞ email, –≤—ã–∑–æ–≤ API)
4. **–ù–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —Å–æ–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏**
## **–î–ï–ö–û–†–ê–¢–û–† VS –ö–û–ù–¢–ï–ö–°–¢–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–†**
### **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä (–¥–ª—è —Ü–µ–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏):**
```python
@transaction.atomic
def complex_operation():
    # –í—Å—è —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    operation1()
    operation2()
    operation3()
```
### **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä (–¥–ª—è —á–∞—Å—Ç–∏ –∫–æ–¥–∞):**
```python
def complex_operation():
    # –ß–∞—Å—Ç—å –∫–æ–¥–∞ –¥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    setup()
    
    with transaction.atomic():
        # –¢–æ–ª—å–∫–æ —ç—Ç–∞ —á–∞—Å—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        critical_operation1()
        critical_operation2()
    
    # –ß–∞—Å—Ç—å –∫–æ–¥–∞ –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    cleanup()
```