## **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï**

**`select_related()`**¬†‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Django ORM, –∫–æ—Ç–æ—Ä—ã–π¬†**–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É N+1**¬†–ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ ForeignKey –∏–ª–∏ OneToOneField. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç¬†**SQL JOIN**¬†–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
## **–ü–†–û–ë–õ–ï–ú–ê, –ö–û–¢–û–†–£–Æ –†–ï–®–ê–ï–¢ select_related()**

### **‚ùå –ë–ï–ó select_related() ‚Äî –ü–†–û–ë–õ–ï–ú–ê N+1:**
```python
# 1 –∑–∞–ø—Ä–æ—Å: –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –≤—Ä–∞—á–µ–π
doctors = Doctor.objects.all()

for doctor in doctors:  # –î–ª—è 10 –≤—Ä–∞—á–µ–π
    print(doctor.clinic.name)  # 10 –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –∑–∞–ø—Ä–æ—Å–æ–≤!
    # –ò–¢–û–ì–û: 1 + 10 = 11 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. **1 –∑–∞–ø—Ä–æ—Å**¬†‚Üí –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
2. **N –∑–∞–ø—Ä–æ—Å–æ–≤**¬†‚Üí –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ä–∞—á–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –∫–ª–∏–Ω–∏–∫—É
3. **–ò—Ç–æ–≥–æ: N+1 –∑–∞–ø—Ä–æ—Å–æ–≤**¬†(–º–µ–¥–ª–µ–Ω–Ω–æ –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
### **‚úÖ –° select_related() ‚Äî –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø:**
```python
# 1 –∑–∞–ø—Ä–æ—Å —Å JOIN: –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–∞—á–µ–π –≤–º–µ—Å—Ç–µ —Å –∏—Ö –∫–ª–∏–Ω–∏–∫–∞–º–∏
doctors = Doctor.objects.select_related('clinic').all()

for doctor in doctors:  # –î–ª—è 10 –≤—Ä–∞—á–µ–π
    print(doctor.clinic.name)  # 0 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤!
    # –ò–¢–û–ì–û: 1 –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```
## **–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ select_related()**

### **–ù–∞ —É—Ä–æ–≤–Ω–µ SQL:**
```python
# Django –∫–æ–¥
Doctor.objects.select_related('clinic').filter(id=1)
```

```sql
-- SQL –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
SELECT 
    doctor.id, doctor.last_name, doctor.clinic_id, 
    clinic.id, clinic.name, clinic.address
FROM doctor
LEFT JOIN clinic ON doctor.clinic_id = clinic.id
WHERE doctor.id = 1;
```
### **–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

1. **–í—ã–ø–æ–ª–Ω—è–µ—Ç JOIN**¬†–º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
2. **–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ**¬†–æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
3. **–£—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**¬†–ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º
4. **–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ**¬†–¥–ª—è ForeignKey –∏ OneToOneField
### üîó –ö–æ–º–±–∏–Ω–∞—Ü–∏—è `select_related` + `prefetch_related`

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**  
–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –ø–æ —Ü–µ–ø–æ—á–∫–µ:  
`ModelA ‚Üí ForeignKey ‚Üí ModelB ‚Üí ManyToMany ‚Üí ModelC`
```python
Restaurant.objects
    .select_related('best_pizza')          # FK ‚Üí 1 –∑–∞–ø—Ä–æ—Å —Å JOIN
    .prefetch_related('best_pizza__toppings')  # M2M ‚Üí +1 –∑–∞–ø—Ä–æ—Å
```
‚úÖ **–ò—Ç–æ–≥–æ: 2 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 3**  
‚úÖ Django **–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç** –∑–∞–≥—Ä—É–∑–∫—É `best_pizza` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ `prefetch_related`

–ò—Å–ø–æ–ª—å–∑—É–π `Prefetch` —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º `queryset`.
```python
from django.db import models

Model.objects.prefetch_related(
    models.Prefetch(
        'related_name',
        queryset=RelatedModel.objects.filter(...).annotate(...).order_by(...)
    )
)
```

```python
Book.objects.prefetch_related(
    models.Prefetch(
        'tags',
        queryset=Tag.objects.filter(is_active=True)
    )
)
```
‚Üí `book.tags.all()` –≤–µ—Ä–Ω—ë—Ç **—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–≥–∏**, –±–µ–∑ N+1.
### ‚ö†Ô∏è –í–∞–∂–Ω–æ

- `select_related` **–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** —Å `ManyToManyField`.
- `prefetch_related` **–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç** —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –±–µ–∑ `Prefetch(...)`.
- –¶–µ–ø–æ—á–∫–∞ `'a__b__c'` –≤ `prefetch_related` –≤–æ–∑–º–æ–∂–Ω–∞, –µ—Å–ª–∏ –≤—Å–µ —Å–≤—è–∑–∏ ‚Äî M2M –∏–ª–∏ –æ–±—Ä–∞—Ç–Ω—ã–µ FK.
- –ü–æ—Å–ª–µ `.prefetch_related(None)` ‚Äî –≤—Å–µ prefetch‚Äô–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è.

---

### üí° –°–æ–≤–µ—Ç

> –ò—Å–ø–æ–ª—å–∑—É–π `select_related` –¥–ª—è **–ø—Ä—è–º—ã—Ö FK/OneToOne**,  
> `prefetch_related` ‚Äî –¥–ª—è **M2M –∏ –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–≤—è–∑–µ–π**,  
> –∏ `Prefetch(...)` ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ **—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –∏–ª–∏ –ª–∏–º–∏—Ç** –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.
## **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï**

### **–ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
```python
# –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–∞—á–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏—Ö –∫–ª–∏–Ω–∏–∫–∞—Ö
def get_doctors_with_clinics():
    return Doctor.objects.select_related('clinic').all()

# –í —à–∞–±–ª–æ–Ω–µ –∏–ª–∏ —Ü–∏–∫–ª–µ:
doctors = get_doctors_with_clinics()
for doctor in doctors:
    # –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤!
    print(f"–í—Ä–∞—á: {doctor.full_name}, –ö–ª–∏–Ω–∏–∫–∞: {doctor.clinic.name}")
    print(f"–ê–¥—Ä–µ—Å –∫–ª–∏–Ω–∏–∫–∏: {doctor.clinic.address}")
```
### **–ü—Ä–∏–º–µ—Ä 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏**
```python
# –ï—Å–ª–∏ —É –≤—Ä–∞—á–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ ForeignKey —Å–≤—è–∑–µ–π
class Doctor(models.Model):
    clinic = models.ForeignKey(Clinic, ...)
    specialization = models.ForeignKey(Specialization, ...)
    department = models.ForeignKey(Department, ...)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
doctors = Doctor.objects.select_related(
    'clinic', 
    'specialization', 
    'department'
).all()
```
### **–ü—Ä–∏–º–µ—Ä 3: –ì–ª—É–±–æ–∫–∏–µ —Å–≤—è–∑–∏ (chaining)**
```python
# –ï—Å–ª–∏ –∫–ª–∏–Ω–∏–∫–∞ —Ç–æ–∂–µ –∏–º–µ–µ—Ç ForeignKey
class Clinic(models.Model):
    city = models.ForeignKey(City, ...)

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Å–≤—è–∑–µ–π
doctors = Doctor.objects.select_related(
    'clinic',          # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–Ω–∏–∫—É
    'clinic__city'     # –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥ —á–µ—Ä–µ–∑ –∫–ª–∏–Ω–∏–∫—É
).all()

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –±–µ–∑ –¥–æ–ø. –∑–∞–ø—Ä–æ—Å–æ–≤:
for doctor in doctors:
    print(f"–ì–æ—Ä–æ–¥ –∫–ª–∏–Ω–∏–∫–∏: {doctor.clinic.city.name}")
```
## **–ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ select_related()**

### **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ select_related() –∫–æ–≥–¥–∞:**

1. **–ï—Å—Ç—å ForeignKey –∏–ª–∏ OneToOneField**¬†—Å–≤—è–∑–∏
2. **–ë—É–¥–µ—Ç–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è**¬†–∫ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º –≤ —Ü–∏–∫–ª–µ
3. **–†–∞–±–æ—Ç–∞–µ—Ç–µ —Å–æ —Å–ø–∏—Å–∫–∞–º–∏**¬†–æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–µ —Å –æ–¥–Ω–∏–º –æ–±—ä–µ–∫—Ç–æ–º)
4. **–ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
5. **–°—Ç—Ä–æ–∏—Ç–µ API**¬†–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö

### **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ select_related() –∫–æ–≥–¥–∞:**

1. **–ù–µ—Ç ForeignKey —Å–≤—è–∑–µ–π**¬†‚Üí –Ω–µ—á–µ–≥–æ JOIN'–∏—Ç—å
2. **–†–∞–±–æ—Ç–∞–µ—Ç–µ —Å –æ–¥–Ω–∏–º –æ–±—ä–µ–∫—Ç–æ–º**¬†‚Üí Django —É–º–Ω—ã–π, –º–æ–∂–µ—Ç —Å–∞–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ ManyToManyField**¬†‚Üí –Ω—É–∂–µ–Ω¬†`prefetch_related()`
4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å**¬†(related_name) ‚Üí –Ω—É–∂–µ–Ω¬†`prefetch_related()`
## **üÜö –°–†–ê–í–ù–ï–ù–ò–ï: select_related() vs prefetch_related()**

| –ö—Ä–∏—Ç–µ—Ä–∏–π               | select_related()                   | prefetch_related()                 |
| ---------------------- | ---------------------------------- | ---------------------------------- |
| **–¢–∏–ø —Å–≤—è–∑–∏**          | ForeignKey, OneToOneField          | ManyToMany, –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–≤—è–∑–∏         |
| **SQL –æ–ø–µ—Ä–∞—Ü–∏—è**       | JOIN (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å)                 | –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (2+ –∑–∞–ø—Ä–æ—Å–∞)     |
| **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** | "–û–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É", "–ú–Ω–æ–≥–∏–µ –∫ –æ–¥–Ω–æ–º—É" | "–ú–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º", –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–≤—è–∑–∏ |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–µ–µ –¥–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Å–≤—è–∑–µ–π        | –õ—É—á—à–µ –¥–ª—è ManyToMany               |
| **–ü–∞–º—è—Ç—å**             | –ú–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ      | –ë–æ–ª–µ–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ                |