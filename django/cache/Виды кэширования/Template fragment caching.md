## –ß—Ç–æ —Ç–∞–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —à–∞–±–ª–æ–Ω–∞?

–≠—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å **–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å HTML-—à–∞–±–ª–æ–Ω–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∞–π–¥–±–∞—Ä, —Ö–µ–¥–µ—Ä, –±–ª–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤), –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è –æ—Å—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.

‚Üí –ò–¥–µ–∞–ª—å–Ω–æ, –∫–æ–≥–¥–∞ **—á–∞—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—á–Ω–∞ –∏–ª–∏ —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è**, –∞ –¥—Ä—É–≥–∞—è ‚Äî –¥–∏–Ω–∞–º–∏—á–Ω–∞ (–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –∫–æ—Ä–∑–∏–Ω–∞).

## ‚öôÔ∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–µ–≥
```django
{% load cache %}
```
### 2. –û–±–µ—Ä–Ω—É—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç
```django
{% cache 500 sidebar %}
    <div class="sidebar">
        <!-- –¢—è–∂—ë–ª–∞—è –ª–æ–≥–∏–∫–∞, –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    </div>
{% endcache %}
```
- `500` ‚Äî —Ç–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö,
- `sidebar` ‚Äî **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è** (–Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è!).
## –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã (per-user, per-language)

–ï—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç **–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —è–∑—ã–∫–∞ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö**, –ø–µ—Ä–µ–¥–∞–π –∏—Ö –∫–∞–∫ **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã**:
```django
<!-- –û—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
{% cache 500 sidebar request.user.id %}
    –ü—Ä–∏–≤–µ—Ç, {{ request.user.username }}!
{% endcache %}
```

```django
<!-- –û—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞ -->
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% cache 600 welcome LANGUAGE_CODE %}
    {% translate "Welcome" %}
{% endcache %}
```
‚Üí Django **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∏—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–ª—é—á –∫—ç—à–∞**.
## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—ç—à

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à —Å –∏–º–µ–Ω–µ–º `"template_fragments"`.  
–ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –±–µ—Ä—ë—Ç—Å—è `"default"`.

–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ:
```django
{% cache 300 promo using="redis_fragments" %}
    ...
{% endcache %}
```
‚Üí –í `settings.py` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
```python
CACHES = {
    "redis_fragments": {
        "BACKEND": "django.core.cache.backends.redis.RedisCache",
        "LOCATION": "redis://...",
    }
}
```
### –¢–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
```django
{% cache my_timeout sidebar %}
```
‚Üí `my_timeout` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **—Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —à–∞–±–ª–æ–Ω–∞.
## –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –∏–∑ –∫–æ–¥–∞

–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ **–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö).

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á:
```python
from django.core.cache.utils import make_template_fragment_key
from django.core.cache import cache

# –î–ª—è {% cache 500 sidebar user.id %}
key = make_template_fragment_key("sidebar", [user.id])
cache.delete(key)
```
## ‚úÖ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π                               | –ü–æ–¥—Ö–æ–¥–∏—Ç?                   |
| -------------------------------------- | --------------------------- |
| –°–ª–æ–∂–Ω—ã–π —Å–∞–π–¥–±–∞—Ä —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö    | ‚úÖ –î–∞                        |
| –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ) | ‚úÖ –î–∞ (—Å `request.user.id`)  |
| –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞        | ‚ùå –ù–µ—Ç                       |
| –ü—Ä–æ—Å—Ç–æ–π —Å—Ç–∞—Ç–∏—á–Ω—ã–π HTML                 | ‚ùå –õ—É—á—à–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é view |
## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

1. **–ò–º—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ ‚Äî —Å—Ç—Ä–æ–∫–∞ –ª–∏—Ç–µ—Ä–∞–ª**, –Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è:  
    ‚úÖ `{% cache 300 "sidebar" %}`  
    ‚ùå `{% cache 300 fragment_name %}`
2. **–ó–Ω–∞—á–µ–Ω–∏—è –≤ `vary_on` —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `str()`** ‚Üí —É–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∏ **—É–Ω–∏–∫–∞–ª—å–Ω—ã –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã**
```python
# –•–æ—Ä–æ—à–æ
request.user.id  # 123

# –ü–ª–æ—Ö–æ
request.user     # "<User object>" ‚Äî –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è
```
3. **–ù–µ –∫—ç—à–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å —Ñ–æ—Ä–º–∞–º–∏ CSRF** ‚Äî —Ç–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–µ—Ç.
## –°–æ–≤–µ—Ç—ã –¥–ª—è –¥–∂—É–Ω–∏–æ—Ä–∞

- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ **—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –±–ª–æ–∫–æ–≤**.
- –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (`user.id`, `LANGUAGE_CODE`), –µ—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.
- –î–ª—è **–æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `make_template_fragment_key`, –Ω–æ **—Ç–µ—Å—Ç–∏—Ä—É–π –∫–ª—é—á–∏**.
- –í 90% —Å–ª—É—á–∞–µ–≤ **—Ö–≤–∞—Ç–∏—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è view** ‚Äî —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã —Ä–µ–¥–∫–æ.

---

## üíé –í—ã–≤–æ–¥

> **Template fragment caching ‚Äî —ç—Ç–æ —Ç–æ—á–µ—á–Ω–æ–µ –æ—Ä—É–¥–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö ¬´—Ç—è–∂—ë–ª—ã—Ö¬ª –±–ª–æ–∫–æ–≤**,  
> –∫–æ–≥–¥–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ (–∏–∑-–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏).  
> –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ **–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ**, —Å –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –∫–ª—é—á–µ–π –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏.